# vim: set filetype=nginx :

upstream backend_@NAME@ {
    server 127.0.0.1:81;
}

upstream backend_@NAME@_osm {
    server osm.nowtaxi.ru;
}

# Для кеширования запросов
proxy_cache_path /var/lib/nginx/@NAME@ levels=1:2 keys_zone=@NAME@:300m max_size=2G;

# Наш любимый формат лога
log_format lextended_@NAME@ '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '[$request_time : $upstream_response_time]';

geoip_country           /usr/share/GeoIP/GeoIP.dat;
geoip_city              /usr/share/GeoIP/GeoLiteCity.dat;



# Параметры буферизации запросов к бэкенду
#proxy_buffering             on;
#proxy_buffer_size           4k;
#proxy_max_temp_file_size    0;
#proxy_buffers               4096 4k;

server {
    listen                  80;
    listen                  443 ssl;

    server_name             @SERVER_NAME@ @SERVER_ALIAS@ munera.nowtaxi.ru;

    # HTTPS
    ssl_certificate         @PROJECT@/config/ssl/certificate.crt;
    ssl_certificate_key     @PROJECT@/config/ssl/cert.key;
    # Кеш SSL сессий (1Мб ~ 4000 сессий)
    ssl_session_cache       shared:SSL:10m;
    ssl_session_timeout     10m;
    # Для уменьшения нагрузки HTTPS
    keepalive_timeout       70;

    # Логи
    access_log              /var/log/nginx/@HOSTNAME@.nowtaxi.access.log lextended_@NAME@;
    error_log               /var/log/nginx/@HOSTNAME@.nowtaxi.error.log;

    # Включим сжатие для статики
    gzip                    on;
    gzip_min_length         150;
    gzip_comp_level         5;
    gzip_disable            msie6;
    gzip_proxied            expired no-cache no-store private auth;
    gzip_types              text/plain          text/css    text/json
                            text/javascript     text/x-js   text/xml
                            text/csv
                            application/xhtml+xml       application/xml
                            application/xml+rss         application/x-rss+xml
                            application/x-javascript    application/javascript
                            application/json
                            image/png   image/gif   image/svg+xml   image/x-icon
                            audio/ogg   audio/mpeg;
    # Устанавливаем в ответ заголовок "Vary: Accept-Encoding"
    gzip_vary               on;


    # для проксируемого event двойная установка этого тега будет вредна
#    add_header  "Access-Control-Allow-Origin" "*";

    # Установим максимальный размер отдаваемого файла
    client_max_body_size    100m;



    # Статику отдаем напрямую минуя upstream сервера
    location ~ ^/(bootstrap|css|js|img|debug-static|audio|bin)/ {
        root                @PROJECT@/public/;
        expires             max;
        charset             UTF-8;
        charset_types       application/x-javascript;
        access_log          off;
    }

    # Закроем доступ к системным файлам
    location ~ /\.(ht|git) {
        deny                all;
    }


    # все что имеет в урле /cache управляет
    location ~ /cached/ {
        # Бэкенд
        proxy_pass                  http://backend_@NAME@;
        # Принудительный кеш на 5 минут
        proxy_cache                 @NAME@;
        proxy_buffering             on;
        proxy_cache_valid           200    301 302 30s;
        proxy_cache_valid           any 1s;
        proxy_cache_lock            on;
        proxy_method                GET;
        proxy_cache_use_stale       updating;

        proxy_cache_lock_timeout    30s;

        proxy_set_header    X-Forwarded-Protocol $scheme;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header          "X-Taxi-Location" "/cached";

        # все что закешировано - все неавторизовано
        proxy_set_header        Cookie '';
        proxy_ignore_headers    'Set-Cookie';
        proxy_cache_key         $uri;
        proxy_hide_header       'Set-Cookie';
        proxy_hide_header       'Expires';
        proxy_hide_header       'Cache-Control';
        #proxy_ignore_headers 'X-Accel-Expires';

        expires    off;
    }


    # Все остальное идет на upstream сервер:
    # Для AJAX запросов установим кеш в 0
    location ~ /ajax/ {
        expires             -1;
        proxy_pass          http://backend_@NAME@;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

        # Почистим если были чанки
#        more_clear_input_headers 'Transfer-Encoding';

        # Передаем протокол дополнительным заголовком, т.к. с бекендом работаем
        # по HTTP и иначе он не знает какой протокол снаружи
        proxy_set_header X-Forwarded-Protocol $scheme;
        add_header  "X-Taxi-Location" "/ajax";
    }


    location ~ ^/admin {
        proxy_pass          http://backend_@NAME@;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

        auth_basic "Restricted";
        auth_basic_user_file @PROJECT@/config/httpd/htpasswd;

        # Почистим если были чанки
#        more_clear_input_headers 'Transfer-Encoding';

        # Передаем протокол дополнительным заголовком, т.к. с бекендом работаем
        # по HTTP и иначе он не знает какой протокол снаружи
        proxy_set_header X-Forwarded-Protocol $scheme;
        proxy_set_header    X-Taxi-Geo              "$geoip_longitude:$geoip_latitude";
    }
    
    # Дефолтный роут использует backend
    location /osm/ {
        rewrite ^/osm/(.*) /$1 break;
        proxy_pass          http://backend_@NAME@_osm;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

        # Почистим если были чанки
#        more_clear_input_headers 'Transfer-Encoding';

        # Передаем протокол дополнительным заголовком, т.к. с бекендом работаем
        # по HTTP и иначе он не знает какой протокол снаружи
        proxy_set_header X-Forwarded-Protocol $scheme;

        proxy_set_header    X-Taxi-Geo              "$geoip_longitude:$geoip_latitude";
    }


    # Дефолтный роут использует backend
    location / {
        proxy_pass          http://backend_@NAME@;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

        # Почистим если были чанки
#        more_clear_input_headers 'Transfer-Encoding';

        # Передаем протокол дополнительным заголовком, т.к. с бекендом работаем
        # по HTTP и иначе он не знает какой протокол снаружи
        proxy_set_header X-Forwarded-Protocol $scheme;

        proxy_set_header    X-Taxi-Geo              "$geoip_longitude:$geoip_latitude";
    }
}

